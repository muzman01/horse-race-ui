<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Win Roller</title>

    <!-- FontAwesome CSS -->
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    />
    <!-- Google Fonts CSS -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;800&display=swap"
    />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Telegram Web App SDK yüklendiğinde çalıştır
        const loadTelegramSDK = () => {
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = "https://telegram.org/js/telegram-web-app.js";
            script.async = true;
            script.onload = () => resolve(window.Telegram);
            script.onerror = () =>
              reject(new Error("Telegram SDK yüklenemedi"));
            document.head.appendChild(script);
          });
        };

        try {
          const tg = await loadTelegramSDK();
          setTimeout(() => {
            tg.WebApp.expand();
            tg.WebApp.ready();
          }, 100);

          // `start_param` ve kullanıcı bilgilerini al
          const startParam = new URLSearchParams(tg.initData).get("start_param");
          console.log("Telegram Web App:", tg);
          console.log("Start Param:", startParam);

          if (startParam) {
            console.log("Kullanıcı start parametresi ile geldi:", startParam);

            // Backend'e kullanıcı bilgilerini gönder
            fetch("http://localhost:8000/trackUser", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                telegramId: tg.initDataUnsafe.user?.id, // Kullanıcının Telegram ID'si
                referrerId: startParam, // Referans olarak gelen ID
              }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                console.log("Kullanıcı kaydedildi:", data);
              })
              .catch((error) => {
                console.error("Kullanıcı kaydedilirken hata oluştu:", error);
              });
          } else {
            console.log("Kullanıcı doğrudan geldi, start param yok.");
          }
        } catch (error) {
          console.error("Telegram SDK yüklenemedi veya hata oluştu:", error);
        }
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
